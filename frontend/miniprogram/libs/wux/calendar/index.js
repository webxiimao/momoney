"use strict";var _baseComponent=_interopRequireDefault(require("../helpers/baseComponent")),_classNames4=_interopRequireDefault(require("../helpers/classNames"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function ownKeys(e,t){var n,a=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,n)),a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var defaults={prefixCls:"wux-calendar",monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthNamesShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["周日","周一","周二","周三","周四","周五","周六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],firstDay:1,weekendDays:[0,6],multiple:!1,dateFormat:"yyyy-mm-dd",direction:"horizontal",minDate:null,maxDate:null,touchMove:!0,animate:!0,closeOnSelect:!0,weekHeader:!0,toolbar:!0,value:[],onMonthAdd:function(){},onChange:function(){},onOpen:function(){},onClose:function(){},onDayClick:function(){},onMonthYearChangeStart:function(){},onMonthYearChangeEnd:function(){}},getTouchPosition=function(t){t=t.touches[0]||t.changedTouches[0];return{x:t.pageX,y:t.pageY}},getTransform=function(t,e){return"transform: translate3d(".concat(e?t:0,"%, ").concat(e?0:t,"%, 0)")},isSameDate=function(t,e){t=new Date(t),e=new Date(e);return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()};(0,_baseComponent.default)({useFunc:!0,data:defaults,computed:{classes:["prefixCls, direction",function(t,e){return{wrap:(0,_classNames4.default)(t,_defineProperty({},"".concat(t,"--").concat(e),e)),content:"".concat(t,"__content"),hd:"".concat(t,"__hd"),toolbar:"".concat(t,"__toolbar"),picker:"".concat(t,"__picker"),link:"".concat(t,"__link"),prev:(0,_classNames4.default)("".concat(t,"__icon"),_defineProperty({},"".concat(t,"__icon--prev"),!0)),next:(0,_classNames4.default)("".concat(t,"__icon"),_defineProperty({},"".concat(t,"__icon--next"),!0)),value:"".concat(t,"__value"),bd:"".concat(t,"__bd"),weekdays:"".concat(t,"__weekdays"),weekday:"".concat(t,"__weekday"),months:"".concat(t,"__months"),monthsContent:"".concat(t,"__months-content"),month:"".concat(t,"__month"),days:"".concat(t,"__days"),day:"".concat(t,"__day"),text:"".concat(t,"__text")}}]},methods:{open:function(){var t=this,e=this.$$mergeOptionsAndBindMethods(Object.assign({},defaults,0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}));this.monthsTranslate=0,this.isH="horizontal"===e.direction,this.$$setData(_objectSpread({in:!0},e)).then(function(){return t.init()}),this.setValue(e.value),"function"==typeof this.fns.onOpen&&this.fns.onOpen.call(this)},close:function(){this.$$setData({in:!1}),"function"==typeof this.fns.onClose&&this.fns.onClose.call(this)},init:function(){var e=this,t=this.setWeekHeader(),n=this.setMonthsHTML(),a=this.setMonthsTranslate();return"function"==typeof this.fns.onMonthAdd&&n.forEach(function(t){return e.fns.onMonthAdd.call(e,t)}),this.$$setData({weeks:t,months:n,monthsTranslate:a,wrapperTranslate:""}).then(function(){return e.$$setData(_objectSpread({},e.updateCurrentMonthYear()))})},setMonthsTranslate:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.monthsTranslate,e=100*-t,n=100*-(t-1);return[getTransform(100*-(t+1),this.isH),getTransform(e,this.isH),getTransform(n,this.isH)]},updateCurrentMonthYear:function(t){var e=this.data,n=e.months,e=e.monthNames;if(void 0===t){var a=parseInt(n[1].month,10);return{currentMonth:a,currentYear:parseInt(n[1].year,10),currentMonthName:e[a]}}a=parseInt(n["next"===t?n.length-1:0].month,10);return{currentMonth:a,currentYear:parseInt(n["next"===t?n.length-1:0].year,10),currentMonthName:e[a]}},onTouchStart:function(t){!this.data.touchMove||this.isMoved||this.isRendered||(this.start=getTouchPosition(t),this.move={},this.touchesDiff=0,this.allowItemClick=!0,this.isMoved=!1)},onTouchMove:function(n){var t,e,a=this;this.data.touchMove&&!this.isRendered&&(this.allowItemClick=!1,this.isMoved||(this.isMoved=!0),this.$$setData({swiping:!0}),t=this.data.prefixCls,(e=wx.createSelectorQuery().in(this)).select(".".concat(t,"__months-content")).boundingClientRect(function(t){var e;t&&a.isMoved&&(a.move=getTouchPosition(n),a.touchesDiff=a.isH?a.move.x-a.start.x:a.move.y-a.start.y,e=t.width,t=t.height,t=a.touchesDiff/(a.isH?e:t),t=100*(a.monthsTranslate+t),t=getTransform(t,a.isH),a.$$setData({wrapperTranslate:"transition-duration: 0s; ".concat(t)}))}),e.exec())},onTouchEnd:function(){var t=this;this.data.touchMove&&this.isMoved&&!this.isRendered&&(this.isMoved=!1,this.$$setData({swiping:!1}),Math.abs(this.touchesDiff)<30?this.resetMonth():30<=this.touchesDiff?this.prevMonth():this.nextMonth(),setTimeout(function(){return t.allowItemClick=!0},100))},onDayClick:function(t){var e,n,a;this.allowItemClick&&(e=(a=t.currentTarget.dataset).year,n=a.month,t=a.day,(a=a.type).selected&&!this.data.multiple||a.disabled||(a.next&&this.nextMonth(),a.prev&&this.prevMonth(),"function"==typeof this.fns.onDayClick&&this.fns.onDayClick.call(this,e,n,t),this.addValue(new Date(e,n,t).getTime()),this.data.closeOnSelect&&!this.data.multiple&&this.close()))},resetMonth:function(){var t=100*this.monthsTranslate,t=getTransform(t,this.isH);this.$$setData({wrapperTranslate:"transition-duration: 0s; ".concat(t)})},setYearMonth:function(){var t,e,n=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.data.currentYear,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.data.currentMonth,o=this.data,r=o.months,i=o.monthsTranslate,h=o.maxDate,c=o.minDate,u=o.currentYear,l=o.currentMonth,o=(a<u?new Date(a,s+1,-1):new Date(a,s)).getTime();h&&o>new Date(h).getTime()||c&&o<new Date(c).getTime()||(l=new Date(u,l).getTime(),t=l<o?"next":"prev",a=this.monthHTML(new Date(a,s)),s=this.monthsTranslate=this.monthsTranslate||0,l<o?(this.monthsTranslate=this.monthsTranslate-1,o=getTransform(100*-(s-1),this.isH),this.$$setData({months:[r[1],r[2],a],monthsTranslate:[i[1],i[2],o]})):(this.monthsTranslate=this.monthsTranslate+1,e=getTransform(100*-(s+1),this.isH),this.$$setData({months:[a,r[0],r[1]],monthsTranslate:[e,i[0],i[1]]})),this.onMonthChangeStart(t),e=getTransform(100*this.monthsTranslate,this.isH),i=this.data.animate?.3:0,e="transition-duration: ".concat(i,"s; ").concat(e),this.$$setData({wrapperTranslate:e}),setTimeout(function(){return n.onMonthChangeEnd(t,!0)},i))},nextYear:function(){this.setYearMonth(this.data.currentYear+1)},prevYear:function(){this.setYearMonth(this.data.currentYear-1)},nextMonth:function(){var t=this,e=this.data,n=e.months,a=e.monthsTranslate,s=e.maxDate,e=e.currentMonth,o=parseInt(n[n.length-1].month,10),n=parseInt(n[n.length-1].year,10),n=new Date(n,o).getTime();if(s&&n>new Date(s).getTime())return this.resetMonth();this.monthsTranslate=this.monthsTranslate-1,o===e&&(r=100*-this.monthsTranslate,i=this.monthHTML(n,"next"),r=getTransform(r,this.isH),i=[this.data.months[1],this.data.months[2],i],this.$$setData({months:i,monthsTranslate:[a[1],a[2],r]}),"function"==typeof this.fns.onMonthAdd&&this.fns.onMonthAdd.call(this,i[i.length-1])),this.onMonthChangeStart("next");var r=getTransform(100*this.monthsTranslate,this.isH),i=this.data.animate?.3:0,r="transition-duration: ".concat(i,"s; ").concat(r);this.$$setData({wrapperTranslate:r}),setTimeout(function(){return t.onMonthChangeEnd("next")},i)},prevMonth:function(){var t=this,e=this.data,n=e.months,a=e.monthsTranslate,s=e.minDate,e=e.currentMonth,o=parseInt(n[0].month,10),n=parseInt(n[0].year,10),n=new Date(n,o+1,-1).getTime();if(s&&n<new Date(s).getTime())return this.resetMonth();this.monthsTranslate=this.monthsTranslate+1,o===e&&(e=100*-this.monthsTranslate,r=this.monthHTML(n,"prev"),e=getTransform(e,this.isH),r=[r,this.data.months[0],this.data.months[1]],this.$$setData({months:r,monthsTranslate:[e,a[0],a[1]]}),"function"==typeof this.fns.onMonthAdd&&this.fns.onMonthAdd.call(this,r[0])),this.onMonthChangeStart("prev");var a=getTransform(100*this.monthsTranslate,this.isH),r=this.data.animate?.3:0,a="transition-duration: ".concat(r,"s; ").concat(a);this.$$setData({wrapperTranslate:a}),setTimeout(function(){return t.onMonthChangeEnd("prev")},r)},onMonthChangeStart:function(t){t=this.updateCurrentMonthYear(t);this.$$setData(t),"function"==typeof this.fns.onMonthYearChangeStart&&this.fns.onMonthYearChangeStart.call(this,t.currentYear,t.currentMonth)},onMonthChangeEnd:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"next",n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=this.data,s=a.currentYear,o=a.currentMonth,r=_toConsumableArray(this.data.months);n?(a=this.monthHTML(new Date(s,o),"prev"),n=this.monthHTML(new Date(s,o),"next"),r=[a,r["next"===e?r.length-1:0],n]):(i=this.monthHTML(new Date(s,o),e),"next"===e?r=[r[1],r[2],i]:"prev"===e&&(r=[i,r[0],r[1]]));var i=this.setMonthsTranslate(this.monthsTranslate);this.isRendered=!0,this.$$setData({months:r,monthsTranslate:i}).then(function(){return t.isRendered=!1}),"function"==typeof this.fns.onMonthAdd&&this.fns.onMonthAdd.call(this,"next"===e?r[r.length-1]:r[0]),"function"==typeof this.fns.onMonthYearChangeEnd&&this.fns.onMonthYearChangeEnd.call(this,s,o)},setWeekHeader:function(){var t=this.data,e=t.weekHeader,n=t.firstDay,a=t.dayNamesShort,s=t.weekendDays,o=[];if(e)for(var r=0;r<7;r++){var i=6<r+n?r-7+n:r+n,h=a[i],i=0<=s.indexOf(i);o.push({weekend:i,dayName:h})}return o},daysInMonth:function(t){t=new Date(t);return new Date(t.getFullYear(),t.getMonth()+1,0).getDate()},monthHTML:function(t,e){var n=(t=new Date(t)).getFullYear(),a=t.getMonth(),s=t.getTime(),o={year:n,month:a,time:s,items:[]};"next"===e&&(t=11===a?new Date(n+1,0):new Date(n,a+1,1)),"prev"===e&&(t=0===a?new Date(n-1,11):new Date(n,a-1,1)),"next"!==e&&"prev"!==e||(a=t.getMonth(),n=t.getFullYear(),s=t.getTime());var r=this.daysInMonth(new Date(t.getFullYear(),t.getMonth()).getTime()-864e6),i=this.daysInMonth(t),h=new Date(t.getFullYear(),t.getMonth()).getDay();0===h&&(h=7);var c=[],u=this.data.firstDay-1,l=(new Date).setHours(0,0,0,0),d=this.data.minDate?new Date(this.data.minDate).getTime():null,m=this.data.maxDate?new Date(this.data.maxDate).getTime():null;if(this.data.value&&this.data.value.length)for(var f=0;f<this.data.value.length;f++)c.push(new Date(this.data.value[f]).setHours(0,0,0,0));for(var p=1;p<=6;p++){for(var g=[],y=1;y<=7;y++){var v=y,D=++u-h,T={};(M=D<0?(D=r+D+1,T.prev=!0,new Date(a-1<0?n-1:n,a-1<0?11:a-1,D).getTime()):i<(D+=1)?(D-=i,T.next=!0,new Date(11<a+1?n+1:n,11<a+1?0:a+1,D).getTime()):new Date(n,a,D).getTime())===l&&(T.today=!0),0<=c.indexOf(M)&&(T.selected=!0),0<=this.data.weekendDays.indexOf(v-1)&&(T.weekend=!0),(d&&M<d||m&&m<M)&&(T.disabled=!0);var v=(M=new Date(M)).getFullYear(),M=M.getMonth();g.push({type:T,year:v,month:M,day:D,date:"".concat(v,"-").concat(M+1,"-").concat(D)})}o.year=n,o.month=a,o.time=s,o.items.push(g)}return o},setMonthsHTML:function(){var t=this.data.value&&this.data.value.length?this.data.value[0]:(new Date).setHours(0,0,0,0);return[this.monthHTML(t,"prev"),this.monthHTML(t),this.monthHTML(t,"next")]},formatDate:function(t){var e=(t=new Date(t)).getFullYear(),n=t.getMonth(),a=n+1,s=t.getDate(),t=t.getDay();return this.data.dateFormat.replace(/yyyy/g,e).replace(/yy/g,(e+"").substring(2)).replace(/mm/g,a<10?"0"+a:a).replace(/m/g,a).replace(/MM/g,this.data.monthNames[n]).replace(/M/g,this.data.monthNamesShort[n]).replace(/dd/g,s<10?"0"+s:s).replace(/d/g,s).replace(/DD/g,this.data.dayNames[t]).replace(/D/g,this.data.dayNamesShort[t])},addValue:function(t){if(this.data.multiple){for(var e=this.data.value||[],n=-1,a=0;a<e.length;a++)isSameDate(t,e[a])&&(n=a);-1===n?e.push(t):e.splice(n,1),this.setValue(e)}else this.setValue([t])},setValue:function(t){var e=this;this.$$setData({value:t}).then(function(){return e.updateValue()})},updateValue:function(){var e=this,i={};this.data.months.forEach(function(t,a){t.items.forEach(function(t,n){t.forEach(function(t,e){t.type.selected&&(i["months[".concat(a,"].items[").concat(n,"][").concat(e,"].type.selected")]=!1)})})});for(var t=0;t<this.data.value.length;t++)!function(t){var t=new Date(e.data.value[t]),s=t.getFullYear(),o=t.getMonth(),r=t.getDate();e.data.months.forEach(function(t,a){t.year===s&&t.month===o&&t.items.forEach(function(t,n){t.forEach(function(t,e){t.year===s&&t.month===o&&t.day===r&&(i["months[".concat(a,"].items[").concat(n,"][").concat(e,"].type.selected")]=!0)})})})}(t);this.$$setData(i),"function"==typeof this.fns.onChange&&this.fns.onChange.call(this,this.data.value,this.data.value.map(function(t){return e.formatDate(t)}))},noop:function(){}}});