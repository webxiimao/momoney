"use strict";var _baseComponent=_interopRequireDefault(require("../helpers/baseComponent")),_classNames2=_interopRequireDefault(require("../helpers/classNames"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(a="Object"===a&&e.constructor?e.constructor.name:a)||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function ownKeys(t,e){var a,r=Object.keys(t);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(t),e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,a)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}(0,_baseComponent.default)({properties:{prefixCls:{type:String,value:"wux-upload"},max:{type:Number,value:-1,observer:"updated"},count:{type:Number,value:9,observer:"updated"},defaultFileType:{type:String,value:"image"},compressed:{type:Boolean,value:!0},maxDuration:{type:Number,value:60},camera:{type:String,value:"back"},sizeType:{type:Array,value:["original","compressed"]},sourceType:{type:Array,value:["album","camera"]},url:{type:String,value:""},name:{type:String,value:"file"},header:{type:Object,value:{}},formData:{type:Object,value:{}},uploaded:{type:Boolean,value:!0},disabled:{type:Boolean,value:!1},progress:{type:Boolean,value:!1},listType:{type:String,value:"text"},defaultFileList:{type:Array,value:[]},fileList:{type:Array,value:[],observer:function(e){this.data.controlled&&this.setData({uploadFileList:e})}},controlled:{type:Boolean,value:!1},showUploadList:{type:Boolean,value:!0},showRemoveIcon:{type:Boolean,value:!0}},data:{uploadMax:-1,uploadCount:9,uploadFileList:[],isVideo:!1},computed:{classes:["prefixCls, disabled, listType",function(e,t,a){var r;return{wrap:(0,_classNames2.default)(e,(_defineProperty(r={},"".concat(e,"--").concat(a),a),_defineProperty(r,"".concat(e,"--disabled"),t),r)),files:"".concat(e,"__files"),file:"".concat(e,"__file"),thumb:"".concat(e,"__thumb"),remove:"".concat(e,"__remove"),select:"".concat(e,"__select"),button:"".concat(e,"__button")}}]},methods:{updated:function(){var e=this.data,t=e.count,e=e.max,t=this.calcValue(t,e),e=t.uploadMax,t=t.uploadCount;this.data.uploadMax===e&&this.data.uploadCount===t||this.setData({uploadMax:e,uploadCount:t})},calcValue:function(e,t){e=parseInt(e),t=-1<parseInt(t)?parseInt(t):-1;return{uploadMax:t,uploadCount:-1!==t&&t<=9&&t<e?t:e}},onSelect:function(){var t=this,e=this.data,a=e.uploadCount,r=e.uploadMax,o=e.sizeType,i=e.sourceType,n=e.uploaded,s=e.disabled,u=e.uploadFileList,l=e.isVideo,c=e.compressed,p=e.maxDuration,e=e.camera,a=this.calcValue(a,r-u.length).uploadCount,r=function(e){e.tempFilePaths=e.tempFilePaths||[e.tempFilePath],t.tempFilePaths=e.tempFilePaths.map(function(e){return{url:e,uid:t.getUid()}}),t.triggerEvent("before",_objectSpread(_objectSpread({},e),{},{fileList:u})),n&&t.uploadFile()};s||(l?wx.chooseVideo({sourceType:i,compressed:c,maxDuration:p,camera:e,success:r}):wx.chooseImage({count:a,sizeType:o,sourceType:i,success:r}))},onChange:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.data.controlled||this.setData({uploadFileList:e.fileList}),this.triggerEvent("change",e)},onStart:function(e){e=_objectSpread(_objectSpread({},e),{},{status:"uploading"});this.onChange({file:e,fileList:[].concat(_toConsumableArray(this.data.uploadFileList),[e])})},onSuccess:function(e,t){var a=_toConsumableArray(this.data.uploadFileList),r=a.map(function(e){return e.uid}).indexOf(e.uid);-1!==r&&(t={file:e=_objectSpread(_objectSpread({},e),{},{status:"done",res:t}),fileList:a},a.splice(r,1,e),this.triggerEvent("success",t),this.onChange(t))},onFail:function(e,t){var a=_toConsumableArray(this.data.uploadFileList),r=a.map(function(e){return e.uid}).indexOf(e.uid);-1!==r&&(t={file:e=_objectSpread(_objectSpread({},e),{},{status:"error",res:t}),fileList:a},a.splice(r,1,e),this.triggerEvent("fail",t),this.onChange(t))},onProgress:function(e,t){var a=_toConsumableArray(this.data.uploadFileList),r=a.map(function(e){return e.uid}).indexOf(e.uid);-1!==r&&(t={file:e=_objectSpread(_objectSpread({},e),{},{progress:t.progress,res:t}),fileList:a},a.splice(r,1,e),this.triggerEvent("progress",t),this.onChange(t))},uploadFile:function(){var e,t,a,r,o,i,n,s,u,l=this;this.tempFilePaths.length&&(e=(u=this.data).url,t=u.name,a=u.header,r=u.formData,o=u.disabled,i=u.progress,n=this.tempFilePaths.shift(),s=n.uid,u=n.url,e&&u&&!o&&(this.onStart(n),this.uploadTask[s]=wx.uploadFile({url:e,filePath:u,name:t,header:a,formData:r,success:function(e){return l.onSuccess(n,e)},fail:function(e){return l.onFail(n,e)},complete:function(e){delete l.uploadTask[s],l.triggerEvent("complete",e),l.uploadFile()}}),i&&this.uploadTask[s].onProgressUpdate(function(e){return l.onProgress(n,e)})))},onPreview:function(e){this.triggerEvent("preview",_objectSpread(_objectSpread({},e.currentTarget.dataset),{},{fileList:this.data.uploadFileList}))},onRemove:function(e){var t=e.currentTarget.dataset.file,a=_toConsumableArray(this.data.uploadFileList),r=a.map(function(e){return e.uid}).indexOf(t.uid);-1!==r&&(t={file:_objectSpread(_objectSpread({},t),{},{status:"remove"}),fileList:a},a.splice(r,1),this.triggerEvent("remove",_objectSpread(_objectSpread({},e.currentTarget.dataset),t)),this.onChange(t))},abort:function(e){var t=this.uploadTask;e?t[e]&&(t[e].abort(),delete t[e]):Object.keys(t).forEach(function(e){t[e]&&(t[e].abort(),delete t[e])})}},created:function(){var e=this;this.index=0,this.createdAt=Date.now(),this.getUid=function(){return"wux-upload--".concat(e.createdAt,"-").concat(++e.index)},this.uploadTask={},this.tempFilePaths=[]},attached:function(){var e=this.data,t=e.defaultFileType,a=e.defaultFileList,r=e.fileList,e=e.controlled;this.setData({uploadFileList:e?r:a,isVideo:"video"===t})},detached:function(){this.abort()}});